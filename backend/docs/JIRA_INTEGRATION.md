# JIRA Ticket Integration

## Overview

The IT Support agent can automatically create JIRA tickets when troubleshooting fails. This feature uses the MCP Atlassian server running in Docker to communicate with JIRA Cloud API.

## Architecture

```
┌──────────────────┐     ┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐
│   IT Support     │     │   MCP Client    │     │  MCP Atlassian   │     │  JIRA Cloud │
│      Agent       │ ──► │   (httpx)       │ ──► │    (Docker)      │ ──► │     API     │
└──────────────────┘     └─────────────────┘     └──────────────────┘     └─────────────┘
                              JSON-RPC 2.0           Port 9000
```

## Prerequisites

1. **JIRA Cloud Account** with API access
2. **Docker** installed and running
3. **API Token** from https://id.atlassian.com/manage-profile/security/api-tokens

## Configuration

### Environment Variables

Add the following to your `.env` file in `backend/env/`:

```env
# JIRA Configuration
JIRA_URL=https://your-company.atlassian.net
JIRA_USERNAME=your.email@company.com
JIRA_API_TOKEN=your_api_token_here
JIRA_PROJECT_KEY=ITSUPPORT

# MCP Server URL (Docker service name when using docker-compose)
MCP_ATLASSIAN_URL=http://mcp-atlassian:9000/mcp
```

### Getting a JIRA API Token

1. Go to https://id.atlassian.com/manage-profile/security/api-tokens
2. Click "Create API token"
3. Give it a label (e.g., "IT Chatbot")
4. Copy the generated token
5. Add it to your `.env` file as `JIRA_API_TOKEN`

### Docker Setup

The MCP Atlassian server runs as a Docker container alongside LiveKit:

```bash
# Start all services (LiveKit + MCP Atlassian)
docker-compose up -d

# Verify MCP Atlassian is running
curl http://localhost:9000/health

# View MCP Atlassian logs
docker-compose logs -f mcp-atlassian
```

### Docker Compose Service

The MCP Atlassian service is defined in `docker-compose.yml`:

```yaml
mcp-atlassian:
  image: ghcr.io/sooperset/mcp-atlassian:latest
  container_name: mcp-atlassian
  ports:
    - "9000:9000"
  environment:
    - JIRA_URL=${JIRA_URL}
    - JIRA_USERNAME=${JIRA_USERNAME}
    - JIRA_API_TOKEN=${JIRA_API_TOKEN}
  command: ["--transport", "streamable-http", "--port", "9000"]
  restart: unless-stopped
```

## How It Works

### User Flow

```
1. User: "Teams is not working"
   └─► IT Agent: Provides troubleshooting steps
       - Restart Teams
       - Clear cache
       - Check network connection
       - etc.

2. User: "Still not working" / "Didn't help"
   └─► IT Agent: "Would you like me to create a JIRA ticket?"

3. User: "Yes" / "Sure" / "Create ticket"
   └─► IT Agent creates JIRA ticket via MCP Atlassian
   └─► Returns: "Created ticket ITSUPPORT-123"
       with URL: https://your-company.atlassian.net/browse/ITSUPPORT-123
```

### Intent Detection

The system detects JIRA confirmation using keywords:
- "yes", "yes please", "yeah", "sure", "ok", "okay"
- "create ticket", "create a ticket", "go ahead"
- "please create", "yes create"

### Ticket Format

**Summary:**
```
IT Support: [First 100 characters of the original issue]
```

**Description:**
```markdown
**Issue Reported:** [Original user message]

**Troubleshooting Steps Attempted:**
[Steps provided by IT agent]

---
*Auto-generated by IT Support Chatbot*
```

## API Reference

### MCP Client

The `mcp_client.py` module provides an async client for the MCP Atlassian server:

```python
from mcp_client import mcp_client

# Create a JIRA issue
result = await mcp_client.create_jira_issue(
    project_key="ITSUPPORT",
    summary="IT Support: Teams not working",
    issue_type="Task",
    description="Issue details..."
)
```

### JSON-RPC Format

The MCP server uses JSON-RPC 2.0 over HTTP:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "jira_create_issue",
    "arguments": {
      "project_key": "ITSUPPORT",
      "summary": "IT Support: Teams not working",
      "issue_type": "Task",
      "description": "Issue details..."
    }
  }
}
```

## Troubleshooting

### "Connection refused" error

**Cause:** MCP Atlassian container is not running

**Solution:**
```bash
# Check if container is running
docker ps | grep mcp-atlassian

# Start the container
docker-compose up -d mcp-atlassian

# Check logs for errors
docker-compose logs mcp-atlassian
```

### "Authentication failed" error

**Cause:** Invalid JIRA credentials

**Solution:**
1. Verify `JIRA_API_TOKEN` is correct and not expired
2. Ensure `JIRA_USERNAME` matches the email associated with the token
3. Check that the token has the necessary permissions

### "Project not found" error

**Cause:** Invalid project key or insufficient permissions

**Solution:**
1. Verify `JIRA_PROJECT_KEY` exists in your JIRA instance
2. Ensure the user has permission to create issues in that project
3. Check project key is uppercase (e.g., "ITSUPPORT" not "itsupport")

### "MCP initialization failed" error

**Cause:** Protocol version mismatch or server error

**Solution:**
```bash
# Restart the MCP Atlassian container
docker-compose restart mcp-atlassian

# Check for updates
docker-compose pull mcp-atlassian
docker-compose up -d mcp-atlassian
```

### Tickets not being created

**Debug steps:**
1. Check backend logs for error messages
2. Verify environment variables are loaded correctly
3. Test MCP server directly:
   ```bash
   curl -X POST http://localhost:9000/mcp \
     -H "Content-Type: application/json" \
     -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-06-18","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}'
   ```

## Security Considerations

1. **API Token Security**: Never commit `.env` files with real tokens
2. **Network Isolation**: MCP Atlassian runs in Docker network, not exposed publicly
3. **Least Privilege**: Create JIRA API token with minimal required permissions
4. **Audit Trail**: All tickets include "Auto-generated by IT Support Chatbot" note

## Extending the Integration

### Adding More Issue Types

Modify `it_jira_create_node` in `specialist_agents.py`:

```python
issue_type = "Bug"  # or "Story", "Task", "Epic"
```

### Adding Custom Fields

Update the MCP client call:

```python
result = await mcp_client.create_jira_issue(
    project_key=project_key,
    summary=summary,
    issue_type="Task",
    description=description,
    # Add custom fields via kwargs
    priority="High",
    components=["IT Support"]
)
```

### Adding Attachments

Currently not supported. Future enhancement could include:
- Screenshot uploads
- Log file attachments
- Conversation transcript

## Related Documentation

- [MCP Atlassian GitHub](https://github.com/sooperset/mcp-atlassian)
- [Atlassian API Documentation](https://developer.atlassian.com/cloud/jira/platform/rest/v3/intro/)
- [Model Context Protocol](https://modelcontextprotocol.io/)
